name: Run Tests with Tag Input

on:
  workflow_dispatch:
    inputs:
      test_tag:
        description: 'Behave tag to run (e.g., @smoke, @OV_03, @High)'
        required: true
        default: '@smoke'
        type: string
      browser:
        description: 'Browser to use for tests'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
      headless:
        description: 'Run tests in headless mode'
        required: false
        default: true
        type: boolean
      generate_reports:
        description: 'Generate HTML and Allure reports'
        required: false
        default: true
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install ${{ inputs.browser }}
          playwright install-deps ${{ inputs.browser }}
      
      - name: Create reports directory
        run: mkdir -p reports/allure_results reports/screenshots reports/traces
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          BROWSER=${{ inputs.browser }}
          HEADLESS=${{ inputs.headless }}
          PORTAL_BASE_URL=${{ secrets.PORTAL_BASE_URL }}
          TEST_EMAIL=${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}
          DEBUG=false
          SCREENSHOT_ON_FAILURE=true
          TRACE=false
          EOF
          echo "âœ… .env file created"
      
      - name: Verify environment
        run: |
          echo "ðŸ” Verifying environment..."
          python --version
          pip list | grep -E "behave|allure|playwright"
          echo ""
          echo "ðŸ“‹ Test configuration:"
          echo "  Tag: ${{ inputs.test_tag }}"
          echo "  Browser: ${{ inputs.browser }}"
          echo "  Headless: ${{ inputs.headless }}"
          echo "  Reports: ${{ inputs.generate_reports }}"
          echo ""
          echo "ðŸ” Checking if tag exists in feature files:"
          if grep -r "${{ inputs.test_tag }}" features/ > /dev/null 2>&1; then
            echo "âœ… Tag found in:"
            grep -r "${{ inputs.test_tag }}" features/ | cut -d: -f1 | sort -u
          else
            echo "âš ï¸ WARNING: Tag '${{ inputs.test_tag }}' not found in any feature files!"
            echo "Available tags:"
            grep -rh "@" features/ | grep -o "@[A-Za-z_0-9]*" | sort -u | head -20
          fi
          echo ""
          echo "ðŸ” Checking secrets (value presence only):"
          [ -n "${{ secrets.PORTAL_BASE_URL }}" ] && echo "âœ… PORTAL_BASE_URL is set" || echo "âŒ PORTAL_BASE_URL is NOT set"
          [ -n "${{ secrets.TEST_EMAIL }}" ] && echo "âœ… TEST_EMAIL is set" || echo "âŒ TEST_EMAIL is NOT set"
          [ -n "${{ secrets.TEST_PASSWORD }}" ] && echo "âœ… TEST_PASSWORD is set" || echo "âŒ TEST_PASSWORD is NOT set"
      
      - name: Dry run to verify tests exist
        run: |
          echo "ðŸ” Performing dry run to check if tests can be found..."
          behave --tags=${{ inputs.test_tag }} --dry-run --no-capture || {
            echo "âŒ Dry run failed! This means:"
            echo "   - Tag '${{ inputs.test_tag }}' might not exist"
            echo "   - Or no scenarios match this tag"
            echo "   - Or there's a syntax error in feature files"
            exit 1
          }
          echo "âœ… Dry run successful - tests found!"
      
      - name: Run tests with tag (with reports)
        if: inputs.generate_reports == true
        env:
          BROWSER: ${{ inputs.browser }}
          HEADLESS: ${{ inputs.headless }}
          PORTAL_BASE_URL: ${{ secrets.PORTAL_BASE_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          set +e  # Don't exit on error
          echo "ðŸ§ª Running tests with tag: ${{ inputs.test_tag }}"
          echo "ðŸ“Š Reports will be generated in: reports/"
          echo ""
          
          # Run with multiple formatters - HTML first for priority
          behave --tags=${{ inputs.test_tag }} \
                 -f html -o reports/behave_report.html \
                 -f allure_behave.formatter:AllureFormatter -o reports/allure_results \
                 -f pretty
          
          TEST_EXIT_CODE=$?
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test execution completed with exit code: $TEST_EXIT_CODE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Show what was generated
          echo ""
          echo "ðŸ“‚ Generated files:"
          ls -lh reports/ || echo "âš ï¸ No reports directory"
          
          # Verify HTML report was created
          if [ -f "reports/behave_report.html" ]; then
            SIZE=$(du -h reports/behave_report.html | cut -f1)
            echo "âœ… HTML report created: $SIZE"
          else
            echo "âŒ WARNING: HTML report not found!"
          fi
          
          # Verify Allure results were created
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results)" ]; then
            FILE_COUNT=$(ls reports/allure_results | wc -l)
            echo "âœ… Allure results created: $FILE_COUNT files"
          else
            echo "âš ï¸ WARNING: Allure results not found or empty"
          fi
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âš ï¸ Tests failed or encountered errors"
            echo "Check the logs above for details"
          fi
          
          exit 0  # Always succeed so we can upload artifacts
        continue-on-error: true
      
      - name: Run tests with tag (without reports)
        if: inputs.generate_reports == false
        env:
          BROWSER: ${{ inputs.browser }}
          HEADLESS: ${{ inputs.headless }}
          PORTAL_BASE_URL: ${{ secrets.PORTAL_BASE_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          behave --tags=${{ inputs.test_tag }} --format pretty || true
        continue-on-error: true
      
      - name: Install Allure CLI
        if: inputs.generate_reports == true && always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          sudo tar -zxvf allure-2.25.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.25.0/bin/allure /usr/bin/allure
      
      - name: Generate Allure report
        if: inputs.generate_reports == true && always()
        run: |
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results)" ]; then
            allure generate reports/allure_results -o reports/allure_report --clean
            echo "âœ… Allure report generated successfully"
          else
            echo "âš ï¸ No Allure results found"
          fi
      
      - name: Check generated files
        if: always()
        run: |
          echo "ðŸ“‚ Checking generated files..."
          echo ""
          echo "Directory structure:"
          ls -la reports/ || echo "âŒ No reports directory found!"
          echo ""
          
          # Check if reports directory exists
          if [ ! -d "reports" ]; then
            echo "âŒ CRITICAL: reports/ directory doesn't exist!"
            echo "This indicates the test execution step failed early."
            exit 0
          fi
          
          # Check each artifact
          echo "Artifact check:"
          if [ -f "reports/behave_report.html" ]; then
            SIZE=$(du -h reports/behave_report.html | cut -f1)
            echo "âœ… HTML report exists (size: $SIZE)"
          else
            echo "âš ï¸ HTML report not found - tests may not have run"
          fi
          
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results 2>/dev/null)" ]; then
            FILE_COUNT=$(ls reports/allure_results | wc -l)
            echo "âœ… Allure results exist ($FILE_COUNT files)"
            ls -lh reports/allure_results | head -5
          else
            echo "âš ï¸ Allure results not found or empty"
            echo "   Possible causes:"
            echo "   - Behave command failed"
            echo "   - No tests matched the tag"
            echo "   - allure-behave formatter not working"
          fi
          
          if [ -d "reports/allure_report" ] && [ -f "reports/allure_report/index.html" ]; then
            echo "âœ… Allure report exists"
          else
            echo "âš ï¸ Allure report not generated"
            echo "   (This is expected if allure-results is empty)"
          fi
          
          if [ -d "reports/screenshots" ] && [ "$(ls -A reports/screenshots 2>/dev/null)" ]; then
            SCREENSHOT_COUNT=$(ls reports/screenshots | wc -l)
            echo "âœ… Screenshots exist ($SCREENSHOT_COUNT files)"
          else
            echo "â„¹ï¸ No screenshots (no test failures)"
          fi
          
          if [ -d "reports/traces" ] && [ "$(ls -A reports/traces 2>/dev/null)" ]; then
            TRACE_COUNT=$(ls reports/traces | wc -l)
            echo "âœ… Traces exist ($TRACE_COUNT files)"
          else
            echo "â„¹ï¸ No traces (no test failures or TRACE disabled)"
          fi
          
          echo ""
          echo "ðŸ’¡ Troubleshooting tips:"
          if [ ! -f "reports/behave_report.html" ] && [ ! -d "reports/allure_results" ]; then
            echo "   - Check if the test tag exists: grep -r '${{ inputs.test_tag }}' features/"
            echo "   - Verify PORTAL_BASE_URL secret is set"
            echo "   - Verify TEST_EMAIL and TEST_PASSWORD secrets are set"
            echo "   - Check 'Run tests with tag' step logs for errors"
          fi
      
      - name: Upload HTML report
        if: inputs.generate_reports == true && always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report-${{ inputs.test_tag }}-${{ github.run_number }}
          path: reports/behave_report.html
          if-no-files-found: warn
          retention-days: 30
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.test_tag }}-${{ github.run_number }}
          path: reports/screenshots/
          if-no-files-found: ignore
          retention-days: 14
      
      - name: Upload traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ inputs.test_tag }}-${{ github.run_number }}
          path: reports/traces/
          if-no-files-found: ignore
          retention-days: 14
      
      - name: Display test summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ inputs.test_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Browser** | ${{ inputs.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Headless** | ${{ inputs.headless }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reports** | ${{ inputs.generate_reports }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "reports/behave_report.html" ]; then
            echo "- âœ… **HTML Report** ($(du -h reports/behave_report.html | cut -f1))" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ HTML Report (not generated)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results 2>/dev/null)" ]; then
            FILE_COUNT=$(ls reports/allure_results | wc -l)
            echo "- âœ… **Allure Results** ($FILE_COUNT files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Allure Results (not generated)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "reports/allure_report" ] && [ -f "reports/allure_report/index.html" ]; then
            echo "- âœ… **Allure Report** (interactive)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Allure Report (not generated)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "reports/screenshots" ] && [ "$(ls -A reports/screenshots 2>/dev/null)" ]; then
            SCREENSHOT_COUNT=$(ls reports/screenshots | wc -l)
            echo "- ðŸ“¸ **Screenshots** ($SCREENSHOT_COUNT files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ Screenshots (none - no failures)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "reports/traces" ] && [ "$(ls -A reports/traces 2>/dev/null)" ]; then
            TRACE_COUNT=$(ls reports/traces | wc -l)
            echo "- ðŸ“Š **Traces** ($TRACE_COUNT files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ Traces (none - no failures)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ How to Access Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the **Actions** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Scroll down to **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "4. Download the reports you need" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Download and open \`html-report\` for quick results" >> $GITHUB_STEP_SUMMARY
          echo "- Download \`allure-report\` and open \`index.html\` for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Check \`screenshots\` if tests failed" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`playwright show-trace <trace.zip>\` to debug failures" >> $GITHUB_STEP_SUMMARY

