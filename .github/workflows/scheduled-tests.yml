name: Scheduled Test Runs

on:
  # Run smoke tests every day at 8 AM UTC
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - high-priority
          - security-posture
          - all

jobs:
  scheduled-tests:
    name: Scheduled ${{ github.event.inputs.test_suite || 'smoke' }} Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üé≠ Install Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: üìÅ Create reports directory
        run: |
          mkdir -p reports/allure_results
          mkdir -p reports/screenshots
          mkdir -p reports/traces

      - name: üß™ Run tests
        env:
          PORTAL_BASE_URL: ${{ secrets.PORTAL_BASE_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          BROWSER: chromium
          HEADLESS: true
          SCREENSHOT_ON_FAILURE: true
          TRACE: true
        run: |
          SUITE="${{ github.event.inputs.test_suite || 'smoke' }}"
          
          case $SUITE in
            smoke)
              TAG="@smoke"
              ;;
            regression)
              TAG="@regression"
              ;;
            high-priority)
              TAG="@High"
              ;;
            security-posture)
              TAG="@SecurityPosture"
              ;;
            all)
              TAG=""
              ;;
            *)
              TAG="@smoke"
              ;;
          esac
          
          echo "üè∑Ô∏è  Running $SUITE tests with tag: $TAG"
          
          if [ -z "$TAG" ]; then
            behave -f html -o reports/behave_report.html \
                   -f allure_behave.formatter:AllureFormatter -o reports/allure_results \
                   -f pretty || true
          else
            behave --tags="$TAG" \
                   -f html -o reports/behave_report.html \
                   -f allure_behave.formatter:AllureFormatter -o reports/allure_results \
                   -f pretty || true
          fi
          
          # Verify reports were created
          echo ""
          echo "üìÇ Generated reports:"
          if [ -f "reports/behave_report.html" ]; then
            SIZE=$(du -h reports/behave_report.html | cut -f1)
            echo "‚úÖ HTML report: $SIZE"
          else
            echo "‚ùå HTML report: NOT FOUND"
          fi
          
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results)" ]; then
            FILE_COUNT=$(ls reports/allure_results | wc -l)
            echo "‚úÖ Allure results: $FILE_COUNT files"
          else
            echo "‚ö†Ô∏è Allure results: EMPTY"
          fi

      - name: üìä Install Allure CLI
        if: always()
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          sudo tar -zxvf allure-2.25.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.25.0/bin/allure /usr/bin/allure

      - name: üìà Generate Allure report
        if: always()
        run: |
          if [ -d "reports/allure_results" ] && [ "$(ls -A reports/allure_results)" ]; then
            allure generate reports/allure_results -o reports/allure_report --clean
          fi

      - name: üì§ Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.inputs.test_suite || 'smoke' }}-${{ github.run_number }}
          path: reports/
          retention-days: 30